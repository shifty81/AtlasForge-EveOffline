name: Atlas Engine Build and Test

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
    paths:
      - 'engine/**'
      - 'editor/**'
      - 'runtime/**'
      - 'atlas_tests/**'
      - 'CMakeLists.txt'
      - '.github/workflows/atlas-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'engine/**'
      - 'editor/**'
      - 'runtime/**'
      - 'atlas_tests/**'
      - 'CMakeLists.txt'
      - '.github/workflows/atlas-ci.yml'
  workflow_dispatch:

# Limit GITHUB_TOKEN permissions to minimum required
permissions:
  contents: read

jobs:
  build-and-test-linux:
    name: Build and Test on Ubuntu
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: Configure CMake (engine, editor, runtime, tests only)
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_ATLAS_ENGINE=ON \
          -DBUILD_ATLAS_EDITOR=ON \
          -DBUILD_ATLAS_RUNTIME=ON \
          -DBUILD_ATLAS_TESTS=ON \
          -DBUILD_CLIENT=OFF \
          -DBUILD_SERVER=OFF

    - name: Build Atlas Engine
      working-directory: build
      run: cmake --build . --config Release --target AtlasEngine -j$(nproc)

    - name: Build Atlas Editor
      working-directory: build
      run: cmake --build . --config Release --target AtlasEditor -j$(nproc)

    - name: Build Atlas Runtime
      working-directory: build
      run: cmake --build . --config Release --target AtlasRuntime -j$(nproc)

    - name: Build Atlas Tests
      working-directory: build
      run: cmake --build . --config Release --target AtlasTests -j$(nproc)

    - name: Run Atlas Engine tests
      working-directory: build
      run: ./atlas_tests/AtlasTests

  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake (engine, editor, runtime, tests only)
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_ATLAS_ENGINE=ON -DBUILD_ATLAS_EDITOR=ON -DBUILD_ATLAS_RUNTIME=ON -DBUILD_ATLAS_TESTS=ON -DBUILD_CLIENT=OFF -DBUILD_SERVER=OFF

    - name: Build all Atlas targets
      working-directory: build
      run: cmake --build . --config Release

    - name: Run Atlas Engine tests
      working-directory: build
      run: |
        if (Test-Path "atlas_tests/Release/AtlasTests.exe") {
          ./atlas_tests/Release/AtlasTests.exe
        } elseif (Test-Path "atlas_tests/AtlasTests.exe") {
          ./atlas_tests/AtlasTests.exe
        } else {
          Write-Host "AtlasTests not found, listing atlas_tests directory:"
          Get-ChildItem -Recurse atlas_tests
        }

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-and-test-linux, build-windows]
    if: always()
    permissions:
      contents: read

    steps:
    - name: Check build results
      run: |
        echo "Atlas Engine Build Summary:"
        echo "==========================="
        echo "Linux:   ${{ needs.build-and-test-linux.result }}"
        echo "Windows: ${{ needs.build-windows.result }}"

        if [[ "${{ needs.build-and-test-linux.result }}" == "success" ]] && \
           [[ "${{ needs.build-windows.result }}" == "success" ]]; then
          echo "✓ All Atlas engine builds and tests passed!"
          exit 0
        else
          echo "✗ Some builds or tests failed"
          exit 1
        fi
